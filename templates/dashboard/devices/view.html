{% extends "core/dashboard/base.html" %} 
{% load static %}
{% block main %}
<main>
    <header class="page-header page-header-dark bg-gradient-primary-to-secondary pb-10">
        <div class="container-xl px-4">
            <div class="page-header-content pt-4">
                <div class="row align-items-center justify-content-between">
                    <div class="col-auto mt-4 mx-auto">
                        <h1 class="page-header-title text-center">
                            {% if perms.core.view_device %}
                            <a href="{% url "view_device_branch" %}" title="Back" style="color: white;" class="btn bg-success m-1" id=""/><i class="fa-solid fa-arrow-left"></i></a>
                            {% endif %}
                            {% if perms.core.add_device %}
                            <a href="{% url "add_device" %}" title="ADD DEVICE" style="color: white;" class="btn bg-warning m-1" id=""/><i class="fa-solid fa-circle-plus"></i></a>
                            <a href="{% url "device_bulk_upload" %}" style="color: white;" title="ADD BULK DEVICE" class="btn bg-success" id=""/><i class="fa-solid fa-file-excel"></i></a>
                            {% endif %}
                        </h1>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Main page content-->
    <div class="container-xl px-4 mt-n10">
        <div class="card mb-4">
            <div class="card-header">DEVICE LISTING</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover text-nowrap display" id="datatable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th class="table-fixed-column">S.N</th>
                                <th class="table-fixed-column">TITLE</th>
                                <th class="table-fixed-column">IP ADDRESS</th>
                                <th class="table-fixed-column">DEVICE TYPE</th>
                                <th class="table-fixed-column">SOL ID</th>
                                <th class="table-fixed-column">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <td>{{ forloop.counter }}</td> <!-- Equivalent to Python's enumerate -->
                                <td>{{ device.title }}</td>
                                <td>{{ device.ip_address }}</td>
                                <td>{{ device.device_type }}</td>
                                <td>{{ device.sol_id|default:"N/A" }}</td> <!-- Use default filter if SOL ID is None -->
                                <td>
                                    <a id="show-ip-int-brief{{forloop.counter}}" data-id="{{device.id}}" class="btn btn-secondary btn-sm show-ip-int-brief" data-bs-toggle="modal" data-bs-target="#deviceModal">Show IP Int Breif</a>
                                    {% if perms.core.backup_device %}
                                    <a id="backup-button{{ forloop.counter }}" data-id="{{ device.id }}" class="btn btn-secondary btn-sm backup-button">Backup</a>
                                    {% endif %}
                                    <a href="#" class="btn btn-secondary btn-sm" id="openDashboard{{ forloop.counter }}" data-dashboard-url="{{ device.grafana_dashboard_url }}" data-bs-toggle="modal" data-bs-target="#dashboardModal">Dashboard</a>
                                    {% if perms.core.access_console %}
                                    <a href="#" class="btn btn-secondary btn-sm Console" id="consoleButton{{ forloop.counter }}" data-device-id="{{ device.id }}">Console</a>
                                    {% endif %}
                                    {% if perms.core.change_device %}
                                    <a href="{% url 'edit_device' device.id %}"  class="btn btn-primary btn-sm">Edit</a>
                                    {% endif %}
                                    {% if perms.core.delete_device %}
                                    <form action="{% url 'delete_device' device.id %}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this device?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6">No devices found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                </div>
            </div>
        </div>
    </div>
</main>
<div class="modal fade" id="dashboardModal" tabindex="-1" role="dialog" aria-labelledby="dashboardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dashboardModalLabel">Grafana Dashboard</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="dashboardIframe" width="100%" height="600px" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg  modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deviceModalLabel">Device Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="device-data">
        </div>
      </div>
    </div>
</div>
<div class="modal fade modal-dialog-scrollable" id="consoleModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Console</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div id="output" class="mb-3"></div>
                    <form id="commandForm" class="d-flex">
                        <input
                            type="text"
                            id="commandInput"
                            class="form-control me-2"
                            autocomplete="off"
                            placeholder="Enter command"
                        />
                        <button type="submit" class="btn btn-primary" id="sendButton" >Send</button>
                        <button type="button" id="clearButton" class="btn btn-danger ms-2">Clear</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="storedDeviceId" value="">
<script>
    (function($) {
        $(document).ready(function() {
            function getDeviceIdFromConsoleButton(button) {
                var deviceId = button.data('device-id');
                return deviceId;
            }
        
            function storeDeviceId(deviceId) {
                $('#storedDeviceId').val(deviceId);
            }

            function clearStoredDeviceId() {
                $('#storedDeviceId').val('');
            }

            $('.Console').on('click', function() {
                var deviceId = getDeviceIdFromConsoleButton($(this));
                if (deviceId) {
                    storeDeviceId(deviceId);
                } else {
                    console.error('No device ID found');
                }
            });
            $(document).on('click', '.close', function() {
                clearStoredDeviceId();
                console.log('Stored device ID cleared');
            });
        });
    })(jQuery);    
</script>
<script>
    (function($) {
        $(document).ready(function() {
            $('#sendButton').on('click', function(e) {
                var command = $('#commandInput').val();
                var deviceId = $('#storedDeviceId').val(); 
        
                $.ajax({
                    url: '/command-log/',
                    type: 'POST',
                    data: { command: command, device_id: deviceId },
                    dataType: 'json',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    success: function(response) {
                        console.log('Command sent successfully:', response);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error sending command:', error);
                    }
                });
            });
        
            function getCookie(name) {
                var cookieValue = "; " + document.cookie;
                var cookies = cookieValue.split("; ");
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].split("=");
                    var key = cookie[0];
                    var value = cookie[1];
                    if (key === name) {
                        return unescape(value);
                    }
                }
                return null;
            }
        });
    })(jQuery);
</script>
<script>
(function($) {
    $(document).ready(function() {
        function initializeWebSocket(deviceId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socket = new WebSocket(`${protocol}//${window.location.host}/ws/device/backup/${deviceId}/`);
    
            socket.onopen = function() {
                toastr.info('Connection established', 'Info');
                sockets[`${deviceId}_connected`] = true;
            };
    
            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                $('#spinner').hide(); 
    
                if (data.status === 'success') {
                    toastr.success(data.message, 'Success');
                } else {
                    toastr.error(data.message, 'Error');
                }
            };
    
            socket.onclose = function() {
                toastr.error('Connection closed', 'Error');
                sockets[`${deviceId}_connected`] = false;
            };
    
            return socket;
        }
    
        const sockets = {};
    
        $('.backup-button').click(function() {
            const deviceId = $(this).data('id');
    
            if (!sockets[deviceId]) {
                sockets[deviceId] = initializeWebSocket(deviceId);
            }
    
            if (sockets[`${deviceId}_connected`]) {
                $('#spinner').show(); 
                sockets[deviceId].send(JSON.stringify({
                    'action': 'backup',
                    'deviceId': deviceId
                }));
            } else {
                toastr.warning('Waiting for connection to establish...', 'Warning');
            }
        });
    });
    
    
    
    
$(document).ready(function() {
    $('.close, .btn-secondary').on('click', function() {
        $('#consoleModal').modal('hide');
        $('#dashboardModal').modal('hide');
    });
});
$(document).ready(function() {
    $(document).on('click', '[id^=openDashboard]', function(e) {
        e.preventDefault();
        var dashboardUrl = $(this).data('dashboard-url');
        if (dashboardUrl) {
            $('#dashboardIframe').attr('src', dashboardUrl);
            $('#dashboardModal').modal('show');
        } else {
            alert('Dashboard URL is not available.');
        }
    });
    
    $('#dashboardModal').on('hidden.bs.modal', function () {
        $('#dashboardIframe').attr('src', '');
    });
});
$(document).ready(function() {
    const outputDiv = $("#output");
    let socket;

    $(document).on("click", "[id^=consoleButton]", function() {
        const deviceId = $(this).data("device-id");
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
            outputDiv.append("<pre>Previous connection closed.</pre>");
        }

        socket = new WebSocket(`${protocol}//${window.location.host}/ws/cisco/${deviceId}/`);

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            outputDiv.append(`<pre>${data.message}</pre>`);
            outputDiv.scrollTop(outputDiv[0].scrollHeight);
        };

        socket.onclose = function() {
            console.log('WebSocket connection closed.');
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        $('#consoleModal').modal('show');
    });

    $("#commandForm").on("submit", function(e) {
        e.preventDefault();
        const command = $("#commandInput").val();
        if (command) {
            socket.send(JSON.stringify({ command: command }));
            $("#commandInput").val("");
        }
    });

    $("#clearButton").on("click", function() {
        outputDiv.html("");
    });

    $(window).on("beforeunload", function() {
        if (socket) {
            socket.close();
        }
    });
});
$(document).ready(function() {
    const outputDiv = $("#output");
    let socket;

    $(document).on("click", "[id^=deviceupDown]", function() {
        const deviceId = $(this).data("device");
        const interfaceName = $(this).data("interface");
        const status = $(this).data("status");
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
            outputDiv.append("<pre>Previous connection closed.</pre>");
        }
        socket = new WebSocket(`${protocol}//${window.location.host}/ws/cisco/updown/`);
        socket.onopen = function(e) {
            console.log('WebSocket connection established');
            $('#spinner').show();
            socket.send(JSON.stringify({
                action: 'updown',
                deviceId: deviceId,
                interfaceName: interfaceName,
                status: status
            }));
        };
    
        socket.onmessage = function(e) {
            $('#spinner').hide();
            const data = JSON.parse(e.data);
            if (data.status === 'success') {
                toastr.success(data.message);
            } else {
                toastr.error(data.message);
            }
        };
    
        socket.onclose = function() {
            console.log('WebSocket connection closed.');
        };
    
        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    });
    
    $("#clearButton").on("click", function() {
        outputDiv.html("");
    });
    
    $(window).on("beforeunload", function() {
        if (socket) {
            socket.close();
        }
    });
});
})(jQuery);
</script>
<style>
    table.dataTable tbody th, table.dataTable tbody td {
        padding: 10px 0px !important;
    }
    #output {
        background-color: #000;
        color: #fff !important;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
    }

    .form-control {
        background-color: #000;
        color: #fff !important;
        font-weight: bold;
        border: none;
    }

    .form-control:focus {
        box-shadow: none;
        background-color: #000;
    }

    pre {
        margin: 0;
        white-space: pre-wrap;
    }
    th, td { text-align: center !important; margin: 5px !important; }
</style>
<script type="text/javascript">
    new DataTable('#datatable');
</script>
<script>
(function($) {
    $(document).ready(function() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        
        $('.show-ip-int-brief').on('click', function(event) {
            event.preventDefault();
            
            const deviceId = $(this).data('id');
            const socket = new WebSocket(`${protocol}//${window.location.host}/ws/device/${deviceId}/`);
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.html) {
                    $('#device-data').html(data.html);
                }
            };
    
            socket.onopen = function() {
                console.log('WebSocket connection established for device', deviceId);
                requestData('show_ip_int_brief');
            };
    
            socket.onclose = function() {
                console.log('WebSocket connection closed for device', deviceId);
            };
    
            socket.onerror = function(error) {
                console.error('WebSocket error for device', deviceId, error);
            };
    
            function requestData(command) {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        'command': command
                    }));
                } else {
                    console.error('WebSocket is not open. Cannot send data.');
                }
            }
        });
    });
})(jQuery);
</script>
{% endblock main %}